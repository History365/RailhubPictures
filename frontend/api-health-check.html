<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RailHub Pictures - API Health Check</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            color: #2c3e50;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .result-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #f9f9f9;
            min-height: 300px;
            overflow-y: auto;
            max-height: 500px;
        }
        pre {
            background-color: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .success {
            color: #2ecc71;
            font-weight: bold;
        }
        .failed {
            color: #e74c3c;
            font-weight: bold;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .summary-box {
            margin-top: 20px;
            padding: 15px;
            background-color: #ecf0f1;
            border-radius: 4px;
        }
        .endpoint-item {
            padding: 8px;
            margin: 5px 0;
            border-left: 4px solid #ddd;
            background-color: #f9f9f9;
        }
        .endpoint-item.success {
            border-left-color: #2ecc71;
            background-color: #eafaf1;
        }
        .endpoint-item.failed {
            border-left-color: #e74c3c;
            background-color: #fdedec;
        }
        .test-timing {
            float: right;
            color: #7f8c8d;
            font-size: 0.9em;
        }
        .clear-log {
            background-color: #95a5a6;
            margin-left: 10px;
        }
    </style>
</head>
<body>
    <h1>RailHub Pictures - API Health Check</h1>
    <p>Use this tool to verify that all API endpoints are functioning correctly across different domain patterns.</p>
    
    <div>
        <button id="runTests">Run Health Check</button>
        <button id="clearLog" class="clear-log">Clear Log</button>
    </div>
    
    <div class="summary-box" id="summary" style="display: none;">
        <h3>Test Summary</h3>
        <p><span id="totalTests">0</span> endpoints tested</p>
        <p><span class="success">✓</span> <span id="successfulTests">0</span> successful</p>
        <p><span class="failed">✗</span> <span id="failedTests">0</span> failed</p>
    </div>
    
    <h2>Results</h2>
    <div class="result-container">
        <div id="results"></div>
    </div>
    
    <h2>Endpoint Status</h2>
    <div id="endpoints"></div>
    
    <script>
        // Configuration
        const mainDomain = 'https://railhubpictures.org';
        const apiSubdomain = 'https://api.railhubpictures.org';
        const altApiSubdomain = 'https://railhub-api.railhubpictures.org';
        
        const endpoints = [
            { url: `${mainDomain}/api/photos/latest?limit=1`, description: "Main domain API" },
            { url: `${apiSubdomain}/photos/latest?limit=1`, description: "API subdomain" },
            { url: `${altApiSubdomain}/photos/latest?limit=1`, description: "Alt API subdomain" }
        ];

        // Add more important endpoints
        const apiEndpoints = [
            { path: '/photos/latest?limit=5', description: "Latest photos" },
            { path: '/photos/featured?limit=1', description: "Featured photos" },
            { path: '/contributors', description: "Contributors list" },
            { path: '/health', description: "Health check" }
        ];
        
        // Add API endpoints to each domain pattern
        apiEndpoints.forEach(endpoint => {
            endpoints.push({ 
                url: `${mainDomain}/api${endpoint.path}`,
                description: `Main domain - ${endpoint.description}`
            });
            
            endpoints.push({ 
                url: `${apiSubdomain}${endpoint.path}`,
                description: `API subdomain - ${endpoint.description}`
            });
        });

        // DOM elements
        const runButton = document.getElementById('runTests');
        const clearButton = document.getElementById('clearLog');
        const resultsDiv = document.getElementById('results');
        const endpointsDiv = document.getElementById('endpoints');
        const summaryDiv = document.getElementById('summary');
        const totalTests = document.getElementById('totalTests');
        const successfulTests = document.getElementById('successfulTests');
        const failedTests = document.getElementById('failedTests');

        // Log functions
        function log(message) {
            const entry = document.createElement('div');
            entry.innerHTML = message;
            resultsDiv.appendChild(entry);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }
        
        function logEndpoint(result) {
            const item = document.createElement('div');
            item.className = `endpoint-item ${result.success ? 'success' : 'failed'}`;
            
            let content = `<strong>${result.description}</strong>`;
            
            if (result.success) {
                content += `<span class="success"> ✓</span>`;
                if (result.duration) {
                    content += `<span class="test-timing">${result.duration}ms</span>`;
                }
            } else {
                content += `<span class="failed"> ✗ ${result.error || `Status: ${result.status}`}</span>`;
            }
            
            content += `<br><small>${result.url}</small>`;
            
            item.innerHTML = content;
            endpointsDiv.appendChild(item);
        }
        
        function updateSummary(results) {
            const successful = results.filter(r => r.success).length;
            const failed = results.length - successful;
            
            totalTests.textContent = results.length;
            successfulTests.textContent = successful;
            failedTests.textContent = failed;
            
            summaryDiv.style.display = 'block';
        }

        // Check a single endpoint
        async function checkEndpoint(url, description) {
            log(`Checking ${description} at ${url}...`);
            
            try {
                const startTime = performance.now();
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json'
                    }
                });
                const endTime = performance.now();
                const duration = (endTime - startTime).toFixed(2);
                
                if (response.ok) {
                    try {
                        const data = await response.json();
                        log(`<span class="success">✓ ${description} - SUCCESS (${duration}ms)</span>`);
                        log(`Status: ${response.status} ${response.statusText}`);
                        log(`<pre>${JSON.stringify(data, null, 2).substring(0, 300)}...</pre>`);
                        return { success: true, duration, url, description };
                    } catch (parseError) {
                        log(`<span class="failed">✗ ${description} - Invalid JSON response</span>`);
                        return { success: false, error: "Invalid JSON", url, description };
                    }
                } else {
                    const text = await response.text();
                    log(`<span class="failed">✗ ${description} - FAILED with status ${response.status}</span>`);
                    log(`<pre>${text}</pre>`);
                    return { success: false, status: response.status, url, description };
                }
            } catch (error) {
                log(`<span class="failed">✗ ${description} - ERROR: ${error.message}</span>`);
                return { success: false, error: error.message, url, description };
            }
        }

        // Run all tests
        async function runHealthCheck() {
            runButton.disabled = true;
            resultsDiv.innerHTML = '';
            endpointsDiv.innerHTML = '';
            
            log("<strong>Starting API Health Check...</strong>");
            log("=".repeat(50));
            
            const results = [];
            
            for (const endpoint of endpoints) {
                const result = await checkEndpoint(endpoint.url, endpoint.description);
                results.push(result);
                logEndpoint(result);
                log("=".repeat(50));
            }
            
            // Summary
            log("<strong>HEALTH CHECK SUMMARY</strong>");
            log("=".repeat(50));
            
            const successful = results.filter(r => r.success).length;
            const failed = results.length - successful;
            
            log(`Total endpoints tested: ${results.length}`);
            log(`<span class="success">✓ Successful: ${successful}</span>`);
            log(`<span class="failed">✗ Failed: ${failed}</span>`);
            
            if (failed > 0) {
                log("<strong>Failed endpoints:</strong>");
                results.filter(r => !r.success).forEach(result => {
                    log(`- ${result.description} (${result.url})`);
                });
                
                log("<strong>Possible issues to check:</strong>");
                log("1. Cloudflare Worker is deployed correctly");
                log("2. Route patterns in wrangler.toml are correct");
                log("3. DNS records are properly configured");
                log("4. CORS headers are properly set");
            }
            
            updateSummary(results);
            runButton.disabled = false;
            
            log("<strong>Health check complete!</strong>");
        }

        // Event listeners
        runButton.addEventListener('click', runHealthCheck);
        
        clearButton.addEventListener('click', () => {
            resultsDiv.innerHTML = '';
            endpointsDiv.innerHTML = '';
            summaryDiv.style.display = 'none';
        });
    </script>
</body>
</html>
