<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RailHub Pictures - Emergency Mode Installer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #d9534f;
            border-bottom: 2px solid #d9534f;
            padding-bottom: 10px;
        }
        .alert {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .alert-danger {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .alert-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        pre {
            background-color: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            overflow: auto;
            margin-bottom: 20px;
        }
        .step {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: #f9f9f9;
        }
        .step-header {
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
            font-size: 18px;
        }
        .step-status {
            margin-top: 10px;
            font-weight: bold;
        }
        .step-status.success {
            color: #28a745;
        }
        .step-status.error {
            color: #dc3545;
        }
        .step-status.pending {
            color: #6c757d;
        }
        button {
            padding: 10px 15px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .file-content {
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            overflow: auto;
            max-height: 400px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚨 RailHub Pictures - Emergency Mode Installer 🚨</h1>
        
        <div class="alert alert-danger">
            <strong>EMERGENCY MODE INSTALLATION</strong><br>
            This page will help you install all required components for emergency mode.
        </div>
        
        <div class="step" id="step1">
            <div class="step-header">Step 1: Check Required Files</div>
            <p>This step will check if all required files for emergency mode exist in the correct location.</p>
            <button onclick="checkFiles()">Check Files</button>
            <div class="step-status pending" id="step1-status">Pending</div>
            <div id="step1-details"></div>
        </div>
        
        <div class="step" id="step2">
            <div class="step-header">Step 2: Generate Required Files</div>
            <p>This step will generate any missing emergency mode files.</p>
            <button onclick="generateFiles()" disabled id="generate-btn">Generate Files</button>
            <div class="step-status pending" id="step2-status">Pending</div>
            <div id="step2-details"></div>
        </div>
        
        <div class="step" id="step3">
            <div class="step-header">Step 3: Update Index Page</div>
            <p>This step will update the index.html file to use the API loader.</p>
            <button onclick="updateIndex()" disabled id="update-index-btn">Update Index</button>
            <div class="step-status pending" id="step3-status">Pending</div>
            <div id="step3-details"></div>
        </div>
        
        <div class="step" id="step4">
            <div class="step-header">Step 4: Test Emergency Mode</div>
            <p>This step will enable emergency mode and test that it works properly.</p>
            <button onclick="testEmergencyMode()" disabled id="test-btn">Test Emergency Mode</button>
            <div class="step-status pending" id="step4-status">Pending</div>
            <div id="step4-details"></div>
        </div>
        
        <div class="alert alert-warning" id="completion-status" style="display: none;">
            <strong>Installation in progress...</strong>
        </div>
    </div>
    
    <script>
        const requiredFiles = [
            '/assets/scripts/cloudflare/emergency-api-client.js',
            '/assets/scripts/api-loader.js',
            '/api-emergency.html'
        ];
        
        const fileContents = {
            '/assets/scripts/cloudflare/emergency-api-client.js': `/**
 * RailHub Pictures Emergency API Client
 * 
 * This is a fallback client that works when Cloudflare Workers are down
 * It implements workarounds to continue functioning even when API endpoints fail
 */

class EmergencyRailHubAPI {
  constructor() {
    console.warn("🚨 INITIALIZING EMERGENCY API CLIENT 🚨");
    
    // Always use the main domain in HTTPS
    this.baseURL = 'https://railhubpictures.org';
    
    // Get auth token from localStorage if available
    this.token = localStorage.getItem('auth_token');
    
    // Set connection status
    this.connectionStatus = {
      connected: true,
      emergency: true,
      endpoint: {
        url: this.baseURL,
        type: 'emergency_fallback',
        description: 'Emergency Fallback (main domain)'
      },
      lastChecked: new Date(),
      error: null
    };
    
    // Cache for mock data
    this._mockDataCache = {
      photos: [],
      units: []
    };
    
    // Try to pre-fetch some data from the homepage
    this._prefetchData();
    
    // Show alert to users
    this._showEmergencyBanner();
  }
  
  // Pre-fetch data from the homepage to use as mock data
  async _prefetchData() {
    try {
      console.log("Pre-fetching data from homepage for emergency mode");
      const mainPageResp = await fetch(this.baseURL, {
        method: 'GET',
        headers: { 'Accept': 'text/html' }
      });
      
      if (mainPageResp.ok) {
        const mainPageText = await mainPageResp.text();
        
        // Extract images for mock photo data
        const imgRegex = /<img[^>]+src=["']([^"']+)["'][^>]*>/gi;
        let match;
        let mockId = 1000;
        
        while ((match = imgRegex.exec(mainPageText)) !== null) {
          const imgSrc = match[1];
          if (imgSrc.includes('.jpg') || imgSrc.includes('.png') || imgSrc.includes('.jpeg')) {
            this._mockDataCache.photos.push({
              id: mockId++,
              url: imgSrc.startsWith('http') ? imgSrc : this.baseURL + (imgSrc.startsWith('/') ? '' : '/') + imgSrc,
              title: "Image from homepage",
              emergency_mode: true,
              description: "API is in emergency mode. This data is extracted from the homepage."
            });
          }
        }
        
        console.log(\`Pre-fetched \${this._mockDataCache.photos.length} images for emergency mode\`);
        
        // Create mock locomotive data
        this._mockDataCache.units = [
          { id: 1, road_name: "BNSF", road_number: "1234", model: "ES44DC" },
          { id: 2, road_name: "UP", road_number: "5678", model: "SD70ACe" },
          { id: 3, road_name: "CPKC", road_number: "9012", model: "ES44AC" },
          { id: 4, road_name: "NS", road_number: "3456", model: "SD40-2" },
          { id: 5, road_name: "CSX", road_number: "7890", model: "ET44AH" }
        ];
      }
    } catch (error) {
      console.error("Error pre-fetching emergency data:", error);
    }
  }
  
  // Show emergency mode banner
  _showEmergencyBanner() {
    if (document.getElementById('api-emergency-banner')) {
      return; // Banner already exists
    }
    
    const banner = document.createElement('div');
    banner.id = 'api-emergency-banner';
    banner.style.position = 'fixed';
    banner.style.top = '0';
    banner.style.left = '0';
    banner.style.width = '100%';
    banner.style.backgroundColor = '#f8d7da';
    banner.style.color = '#721c24';
    banner.style.padding = '10px';
    banner.style.textAlign = 'center';
    banner.style.fontWeight = 'bold';
    banner.style.zIndex = '9999';
    banner.style.borderBottom = '1px solid #f5c6cb';
    
    banner.innerHTML = \`
      🚨 API EMERGENCY MODE 🚨
      <br>
      <span style="font-weight: normal; font-size: 0.9em">
        The API is currently experiencing issues. Limited functionality available.
        <button id="hide-emergency-banner" style="margin-left: 10px; padding: 3px 8px; background: #721c24; color: white; border: none; cursor: pointer; border-radius: 3px;">
          Hide
        </button>
      </span>
    \`;
    
    document.body.appendChild(banner);
    
    // Add event listener to hide button
    document.getElementById('hide-emergency-banner').addEventListener('click', () => {
      banner.style.display = 'none';
    });
    
    // Add some margin to the body to prevent content from being hidden behind the banner
    const currentBodyMargin = parseInt(getComputedStyle(document.body).marginTop) || 0;
    document.body.style.marginTop = (currentBodyMargin + banner.offsetHeight) + 'px';
  }
  
  // Get default fetch options with authorization header
  _getOptions(options = {}) {
    const headers = {
      ...options.headers
    };
    
    if (this.token) {
      headers['Authorization'] = \`Bearer \${this.token}\`;
    }
    
    return {
      ...options,
      headers
    };
  }
  
  // Try to auto-detect the best endpoint
  async detectBestEndpoint() {
    console.log("Emergency mode active - using main domain only");
    return {
      url: this.baseURL,
      type: 'emergency_fallback',
      description: 'Emergency Fallback'
    };
  }
  
  // Test connection to all endpoints
  async testConnection() {
    console.log("Running connection test in emergency mode");
    
    // Only test the main domain
    try {
      const response = await fetch(this.baseURL, {
        method: 'GET',
        mode: 'cors',
        cache: 'no-cache',
        signal: AbortSignal.timeout(3000)
      });
      
      const result = {
        endpoint: {
          url: this.baseURL,
          type: 'emergency_fallback',
          description: 'Emergency Fallback'
        },
        success: response.ok,
        status: response.status,
        statusText: response.statusText,
        responseTime: 0,
        error: null
      };
      
      return {
        success: response.ok,
        message: response.ok ? 'Emergency mode active and connected' : 'Emergency mode active but connection failed',
        currentBaseURL: this.baseURL,
        results: [result],
        emergency: true
      };
    } catch (error) {
      return {
        success: false,
        message: 'Emergency mode active but connection failed',
        currentBaseURL: this.baseURL,
        results: [{
          endpoint: {
            url: this.baseURL,
            type: 'emergency_fallback',
            description: 'Emergency Fallback'
          },
          success: false,
          status: null,
          statusText: null,
          responseTime: null,
          error: error.message || 'Unknown error'
        }],
        emergency: true
      };
    }
  }
  
  // Check if we're authenticated
  isAuthenticated() {
    return !!this.token;
  }
  
  // Set the authentication token
  setToken(token) {
    this.token = token;
    localStorage.setItem('auth_token', token);
  }
  
  // Clear the authentication token (logout)
  clearToken() {
    this.token = null;
    localStorage.removeItem('auth_token');
  }
  
  // Perform API request with fallbacks for emergency mode
  async _fetch(endpoint, options = {}) {
    try {
      console.log(\`Emergency mode API request: \${endpoint}\`);
      
      // Handle specific endpoints with mock data
      if (endpoint.includes('/photos/latest')) {
        console.log("Returning mock photo data in emergency mode");
        return this._mockDataCache.photos;
      } 
      else if (endpoint.includes('/photos/') && !endpoint.includes('/upload')) {
        // For specific photo, return first mock photo
        console.log("Returning mock single photo in emergency mode");
        return this._mockDataCache.photos[0] || {
          id: 999,
          url: \`\${this.baseURL}/assets/images/logo.jpg\`,
          title: "Placeholder Image",
          emergency_mode: true,
          description: "API is in emergency mode. This is placeholder data."
        };
      }
      else if (endpoint.includes('/units')) {
        // For units, return mock data
        console.log("Returning mock units data in emergency mode");
        return this._mockDataCache.units;
      }
      else if (endpoint.includes('/photos/upload') && options.method === 'POST') {
        // For upload, try direct upload but expect it to fail
        console.log("Attempting upload in emergency mode");
        try {
          // Try direct upload to the main domain /upload path
          const uploadResp = await fetch(\`\${this.baseURL}/upload\`, this._getOptions(options));
          
          if (uploadResp.ok) {
            return { success: true, message: "Upload processed in emergency mode" };
          } else {
            console.warn("Upload failed with status:", uploadResp.status);
            return { 
              success: false, 
              error: "Upload failed in emergency mode.",
              emergency_mode: true
            };
          }
        } catch (uploadError) {
          console.error("Upload failed in emergency mode:", uploadError);
          return { 
            success: false, 
            error: "Unable to upload in emergency mode. Please try again later.",
            emergency_mode: true
          };
        }
      }
      else if (endpoint.includes('/users/')) {
        // For user profiles, return mock user data
        return {
          id: 1,
          username: "emergency_user",
          displayName: "Emergency Mode User",
          bio: "API is in emergency mode. This is mock user data.",
          emergency_mode: true,
          photos: this._mockDataCache.photos.slice(0, 5) // First 5 mock photos
        };
      }
      
      // For any other endpoint, try to fetch from the main domain
      try {
        // Try direct access to main domain (no /api)
        const url = \`\${this.baseURL}\${endpoint.replace(/^\\/api/, '')}\`;
        console.log(\`Attempting fetch from: \${url}\`);
        
        const response = await fetch(url, this._getOptions(options));
        
        if (response.ok) {
          try {
            // Try to parse as JSON
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
              return await response.json();
            } else {
              // Return raw response if not JSON
              return response;
            }
          } catch (parseError) {
            console.warn("Error parsing response as JSON:", parseError);
            return response;
          }
        } else {
          // If fetch fails, return an appropriate emergency response
          console.warn(\`Fetch failed with status: \${response.status}\`);
          return {
            success: false,
            error: \`API request failed in emergency mode: \${response.status}\`,
            emergency_mode: true
          };
        }
      } catch (fetchError) {
        console.error("Fetch failed in emergency mode:", fetchError);
        return {
          success: false,
          error: \`Failed to connect in emergency mode: \${fetchError.message}\`,
          emergency_mode: true
        };
      }
    } catch (error) {
      console.error("Error in emergency API call:", error);
      return {
        success: false,
        error: \`Emergency mode error: \${error.message}\`,
        emergency_mode: true
      };
    }
  }
  
  // API endpoint implementations that use _fetch
  
  async getLatestPhotos(limit = 20) {
    return await this._fetch(\`/photos/latest?limit=\${limit}\`);
  }
  
  async getPhoto(id) {
    return await this._fetch(\`/photos/\${id}\`);
  }
  
  async uploadPhoto(formData) {
    return await this._fetch('/photos/upload', {
      method: 'POST',
      body: formData
    });
  }
  
  async getUnitPhotos(unitId) {
    return await this._fetch(\`/units/\${unitId}/photos\`);
  }
  
  async getUserProfile(identifier) {
    return await this._fetch(\`/users/\${identifier}\`);
  }
  
  async getAllUnits() {
    return await this._fetch('/units');
  }
  
  async getSuggestedEdits() {
    return await this._fetch('/admin/suggestions');
  }
  
  async processSuggestedEdit(id, action) {
    return await this._fetch(\`/admin/suggestions/\${id}/\${action}\`, {
      method: 'POST'
    });
  }
}`,
            '/assets/scripts/api-loader.js': `/**
 * RailHub API Loader
 * 
 * This script detects if emergency mode is enabled and loads the appropriate API client.
 * Include this script before any other scripts that depend on the API.
 */

(function() {
    // Check if emergency mode is enabled in localStorage
    const emergencyMode = localStorage.getItem('railhub_emergency_mode') === 'true';
    
    // Log emergency mode status
    console.log(\`RailHub API Loader: Emergency mode is \${emergencyMode ? 'ENABLED' : 'disabled'}\`);
    
    // Load appropriate API client script
    const scriptElement = document.createElement('script');
    
    if (emergencyMode) {
        scriptElement.src = '/assets/scripts/cloudflare/emergency-api-client.js';
        scriptElement.onload = function() {
            console.log('Emergency API client loaded successfully');
            window.railhubAPI = new EmergencyRailHubAPI();
            
            // Dispatch event to notify other scripts that API is ready
            window.dispatchEvent(new CustomEvent('railhub-api-ready', { 
                detail: { emergency: true }
            }));
        };
    } else {
        // Load the regular API client
        scriptElement.src = '/assets/scripts/cloudflare/api-client.js';
        scriptElement.onload = function() {
            console.log('Standard API client loaded successfully');
            
            // Initialize the API client
            window.railhubAPI = new RailHubAPI();
            
            // Detect best endpoint and initialize
            window.railhubAPI.detectBestEndpoint()
                .then(endpoint => {
                    console.log('Best API endpoint detected:', endpoint);
                    
                    // Dispatch event to notify other scripts that API is ready
                    window.dispatchEvent(new CustomEvent('railhub-api-ready', { 
                        detail: { emergency: false }
                    }));
                })
                .catch(error => {
                    console.error('Error detecting best API endpoint:', error);
                    
                    // Show warning about API issues
                    const warning = document.createElement('div');
                    warning.style.backgroundColor = '#fff3cd';
                    warning.style.color = '#856404';
                    warning.style.padding = '10px';
                    warning.style.margin = '10px 0';
                    warning.style.borderRadius = '4px';
                    warning.style.textAlign = 'center';
                    warning.innerHTML = \`
                        <strong>Warning:</strong> API connection issues detected. 
                        <a href="/api-emergency.html" style="color: #856404; font-weight: bold;">
                            Enable emergency mode
                        </a>
                    \`;
                    document.body.insertBefore(warning, document.body.firstChild);
                    
                    // Try to continue anyway
                    window.dispatchEvent(new CustomEvent('railhub-api-ready', { 
                        detail: { emergency: false, error: error }
                    }));
                });
        };
    }
    
    scriptElement.onerror = function() {
        console.error(\`Failed to load \${emergencyMode ? 'emergency' : 'standard'} API client\`);
        
        // Create error message
        const errorElement = document.createElement('div');
        errorElement.style.backgroundColor = '#f8d7da';
        errorElement.style.color = '#721c24';
        errorElement.style.padding = '10px';
        errorElement.style.margin = '10px 0';
        errorElement.style.borderRadius = '4px';
        errorElement.style.textAlign = 'center';
        errorElement.innerHTML = \`
            <strong>Error:</strong> Failed to load API client. 
            <a href="/api-emergency.html" style="color: #721c24; font-weight: bold;">
                Try emergency mode
            </a>
        \`;
        
        // Add to page if body exists
        if (document.body) {
            document.body.insertBefore(errorElement, document.body.firstChild);
        } else {
            // If body doesn't exist yet, wait for it
            document.addEventListener('DOMContentLoaded', function() {
                document.body.insertBefore(errorElement, document.body.firstChild);
            });
        }
    };
    
    // Add the script to the document
    document.head.appendChild(scriptElement);
})();`
        };
        
        // Check if files exist
        async function checkFiles() {
            const step1Status = document.getElementById('step1-status');
            const step1Details = document.getElementById('step1-details');
            step1Status.className = 'step-status pending';
            step1Status.textContent = 'Checking...';
            step1Details.innerHTML = '';
            
            const results = [];
            for (const filePath of requiredFiles) {
                try {
                    const response = await fetch(filePath, { method: 'HEAD' });
                    results.push({
                        path: filePath,
                        exists: response.ok,
                        status: response.status
                    });
                } catch (error) {
                    results.push({
                        path: filePath,
                        exists: false,
                        error: error.message
                    });
                }
            }
            
            // Display results
            let allExist = true;
            let resultsHtml = '<ul>';
            
            for (const result of results) {
                if (!result.exists) {
                    allExist = false;
                }
                
                resultsHtml += `<li>
                    ${result.path}: 
                    ${result.exists ? 
                        '<span style="color: #28a745;">✓ Exists</span>' : 
                        '<span style="color: #dc3545;">✗ Not found</span>'
                    }
                </li>`;
            }
            
            resultsHtml += '</ul>';
            step1Details.innerHTML = resultsHtml;
            
            if (allExist) {
                step1Status.className = 'step-status success';
                step1Status.textContent = 'All files found!';
                document.getElementById('generate-btn').disabled = true;
                document.getElementById('update-index-btn').disabled = false;
                document.getElementById('test-btn').disabled = false;
            } else {
                step1Status.className = 'step-status error';
                step1Status.textContent = 'Missing files';
                document.getElementById('generate-btn').disabled = false;
                document.getElementById('update-index-btn').disabled = true;
                document.getElementById('test-btn').disabled = true;
            }
            
            return { results, allExist };
        }
        
        // Generate missing files
        async function generateFiles() {
            const step2Status = document.getElementById('step2-status');
            const step2Details = document.getElementById('step2-details');
            step2Status.className = 'step-status pending';
            step2Status.textContent = 'Generating...';
            step2Details.innerHTML = '';
            
            const { results } = await checkFiles();
            const missingFiles = results.filter(r => !r.exists);
            
            if (missingFiles.length === 0) {
                step2Status.className = 'step-status success';
                step2Status.textContent = 'No files need to be generated';
                return;
            }
            
            let generatedHtml = '<ul>';
            let allGenerated = true;
            
            for (const file of missingFiles) {
                const path = file.path;
                const content = fileContents[path];
                
                if (!content) {
                    generatedHtml += `<li>${path}: <span style="color: #dc3545;">✗ No template available</span></li>`;
                    allGenerated = false;
                    continue;
                }
                
                try {
                    // For demonstration, we'll just show the content since we can't actually
                    // write to the filesystem from the browser
                    generatedHtml += `<li>${path}: <span style="color: #28a745;">✓ Generated</span></li>`;
                    
                    // Show file content
                    generatedHtml += `<div class="file-content" style="max-height: 200px; overflow: auto; margin: 10px 0; padding: 10px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; font-size: 12px;">
                        Content preview (first 100 chars): ${content.substring(0, 100)}...
                    </div>`;
                    
                    // In a real implementation, we would write the file here
                } catch (error) {
                    generatedHtml += `<li>${path}: <span style="color: #dc3545;">✗ Error: ${error.message}</span></li>`;
                    allGenerated = false;
                }
            }
            
            generatedHtml += '</ul>';
            generatedHtml += `<div class="alert alert-warning">
                Note: In this demo, files aren't actually written to the filesystem. 
                In a real implementation, you would need to manually save these files.
            </div>`;
            
            step2Details.innerHTML = generatedHtml;
            
            if (allGenerated) {
                step2Status.className = 'step-status success';
                step2Status.textContent = 'All files generated';
                document.getElementById('update-index-btn').disabled = false;
                // Re-check files after generating
                await checkFiles();
            } else {
                step2Status.className = 'step-status error';
                step2Status.textContent = 'Some files could not be generated';
            }
        }
        
        // Update index.html
        async function updateIndex() {
            const step3Status = document.getElementById('step3-status');
            const step3Details = document.getElementById('step3-details');
            step3Status.className = 'step-status pending';
            step3Status.textContent = 'Updating...';
            step3Details.innerHTML = '';
            
            try {
                // Fetch index.html
                const response = await fetch('/index.html');
                if (!response.ok) {
                    throw new Error(`Failed to fetch index.html: ${response.status}`);
                }
                
                let content = await response.text();
                
                // Check if api-loader.js is already included
                if (content.includes('api-loader.js')) {
                    step3Status.className = 'step-status success';
                    step3Status.textContent = 'API loader already included in index.html';
                    step3Details.innerHTML = '<div class="alert alert-success">The index.html file is already set up to use the API loader.</div>';
                    document.getElementById('test-btn').disabled = false;
                    return;
                }
                
                // Replace the api-client.js script tag with api-loader.js
                const oldPattern = `<script src="assets/scripts/cloudflare/api-client.js"></script>`;
                const newPattern = `<!-- API Loader - will load either standard or emergency API client based on mode -->
    <script src="assets/scripts/api-loader.js"></script>`;
                
                if (content.includes(oldPattern)) {
                    content = content.replace(oldPattern, newPattern);
                    
                    // In a real implementation, we would write the file here
                    step3Status.className = 'step-status success';
                    step3Status.textContent = 'Index updated successfully';
                    step3Details.innerHTML = `
                        <div class="alert alert-success">Successfully updated index.html to use API loader.</div>
                        <p>Old code:</p>
                        <pre>${oldPattern}</pre>
                        <p>New code:</p>
                        <pre>${newPattern}</pre>
                        <div class="alert alert-warning">
                            Note: In this demo, files aren't actually written to the filesystem.
                            In a real implementation, you would need to manually save these changes.
                        </div>
                    `;
                    document.getElementById('test-btn').disabled = false;
                } else {
                    step3Status.className = 'step-status error';
                    step3Status.textContent = 'Could not find API client script tag';
                    step3Details.innerHTML = '<div class="alert alert-danger">Could not find the API client script tag in index.html. You may need to manually update the file.</div>';
                }
            } catch (error) {
                step3Status.className = 'step-status error';
                step3Status.textContent = 'Error updating index';
                step3Details.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
            }
        }
        
        // Test emergency mode
        async function testEmergencyMode() {
            const step4Status = document.getElementById('step4-status');
            const step4Details = document.getElementById('step4-details');
            step4Status.className = 'step-status pending';
            step4Status.textContent = 'Testing...';
            step4Details.innerHTML = '';
            
            try {
                // Enable emergency mode
                localStorage.setItem('railhub_emergency_mode', 'true');
                localStorage.setItem('railhub_emergency_timestamp', new Date().toISOString());
                
                // Try to load the emergency API client
                const scriptElement = document.createElement('script');
                scriptElement.src = '/assets/scripts/cloudflare/emergency-api-client.js';
                
                // Create a promise to wait for script load
                const scriptPromise = new Promise((resolve, reject) => {
                    scriptElement.onload = () => resolve(true);
                    scriptElement.onerror = () => reject(new Error('Failed to load emergency client'));
                    document.head.appendChild(scriptElement);
                });
                
                // Wait for script to load
                await scriptPromise;
                
                step4Status.className = 'step-status success';
                step4Status.textContent = 'Emergency mode enabled and tested';
                step4Details.innerHTML = `
                    <div class="alert alert-success">
                        <strong>Emergency mode has been successfully enabled!</strong><br>
                        You can now navigate to any page on the site to use emergency mode.
                    </div>
                    <p>
                        <a href="/index.html" target="_blank" class="btn btn-primary">
                            Open homepage with emergency mode
                        </a>
                        <a href="/api-emergency.html" target="_blank" class="btn btn-primary">
                            Open emergency control panel
                        </a>
                    </p>
                `;
                
                document.getElementById('completion-status').style.display = 'block';
                document.getElementById('completion-status').className = 'alert alert-success';
                document.getElementById('completion-status').innerHTML = '<strong>✅ Installation Complete!</strong><br>Emergency mode has been successfully installed and activated.';
                
            } catch (error) {
                step4Status.className = 'step-status error';
                step4Status.textContent = 'Error testing emergency mode';
                step4Details.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
                
                document.getElementById('completion-status').style.display = 'block';
                document.getElementById('completion-status').className = 'alert alert-danger';
                document.getElementById('completion-status').innerHTML = `<strong>❌ Installation Failed</strong><br>Could not enable emergency mode: ${error.message}`;
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Check for existing emergency mode
            if (localStorage.getItem('railhub_emergency_mode') === 'true') {
                const timestamp = localStorage.getItem('railhub_emergency_timestamp');
                document.getElementById('completion-status').style.display = 'block';
                document.getElementById('completion-status').className = 'alert alert-warning';
                document.getElementById('completion-status').innerHTML = `
                    <strong>Emergency Mode Already Active</strong><br>
                    Emergency mode was enabled on: ${new Date(timestamp).toLocaleString()}
                    <br><br>
                    <a href="/api-emergency.html" class="btn btn-warning">Manage Emergency Mode</a>
                `;
            }
        });
    </script>
</body>
</html>
