<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Profile | Railhub Pictures</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <link href="assets/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/stylesheet/theme.css" rel="stylesheet">
    <link href="assets/stylesheet/styles.css" rel="stylesheet">
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="assets/images/favicon.png">
    <script
      async
      crossorigin="anonymous"
      data-clerk-publishable-key="pk_test_Y29tbXVuYWwtY2F0LTI1LmNsZXJrLmFjY291bnRzLmRldiQ"
      src="https://communal-cat-25.clerk.accounts.dev/npm/@clerk/clerk-js@5/dist/clerk.browser.js"
      type="text/javascript">
    </script>
    <script src="assets/scripts/clerk-auth.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f8f8;
            padding-top: 100px;
        }
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 3rem 0;
        }
        .profile-avatar {
            width: 120px;
            height: 120px;
            border: 4px solid rgba(255,255,255,0.3);
        }
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header style="padding: 1rem 0; background: #fff; position: fixed; top: 0; left: 0; width: 100%; z-index: 1000; font-family: 'Inter', Helvetica, Arial, sans-serif; box-shadow: 0 1px 3px rgba(0,0,0,0.08); border-bottom: 1px solid #eee; box-sizing: border-box;">
        <div style="display: flex; flex-direction: column; max-width: 1200px; margin: 0 auto; padding: 0 1rem;">
            <!-- Top Row with Logo and Account -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                <a href="index.html" style="display: flex; align-items: center;">
                    <img src="assets/images/logos/logo.jpg" alt="Logo" style="max-width: 250px; height: auto;">
                </a>
                <div style="display: flex; align-items: center; gap: 1.5rem;">
                    <span style="color: #666; font-size: 0.95em;" id="userInfo"></span>
                    <script>
                        var today = new Date();
                        var dd = String(today.getDate()).padStart(2, '0');
                        var mm = String(today.getMonth() + 1).padStart(2, '0');
                        var yyyy = today.getFullYear();
                        document.write('<span style="color: #666;">' + mm + '/' + dd + '/' + yyyy + '</span>');
                    </script>
                    <div style="display: flex; gap: 1rem;" id="auth-buttons">
                        <!-- Auth buttons will be dynamically inserted by Clerk -->
                    </div>
                </div>
            </div>
            <!-- Bottom Row with Navigation and Search -->
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <nav style="display: flex; gap: 1.75rem;">
                    <a href="index.html" style="color: #444; text-decoration: none; font-weight: 500; font-size: 0.95em;">Home</a>
                    <a href="newestphotos.html" style="color: #444; text-decoration: none; font-weight: 500; font-size: 0.95em;">Newest Photos</a>
                    <a href="contribPicks.html" style="color: #444; text-decoration: none; font-weight: 500; font-size: 0.95em;">Contributor Picks</a>
                    <a href="railroadList.html" style="color: #444; text-decoration: none; font-weight: 500; font-size: 0.95em;">Railroads</a>
                </nav>
                <div style="display: flex; gap: 1rem; align-items: center;">
                    <form action="search.html" method="get" style="display: flex; gap: 0.5rem;">
                        <input type="text" name="q" placeholder="Search..." style="padding: 0.6em 0.9em; border: 1px solid #eee; border-radius: 6px; font-size: 0.95em; width: 220px; background: #f5f5f5; color: #444; font-family: 'Inter', sans-serif;">
                        <button type="submit" style="background: #444; color: #fff; border: none; padding: 0.6em 1em; border-radius: 6px; font-size: 0.95em; cursor: pointer; font-family: 'Inter', sans-serif; font-weight: 500;">Search</button>
                    </form>
                    <a href="upload.html" style="color: #fff; text-decoration: none; font-weight: 500; font-size: 0.95em; background: #444; padding: 0.6em 1.2em; border-radius: 6px; display: inline-flex; align-items: center; gap: 0.5rem;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        Upload
                    </a>
                </div>
            </div>
        </div>
    </header>

    <!-- Profile Header -->
    <section class="py-5">
        <div class="container">
            <!-- Profile Header with Background -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm mb-4" id="profile-header-card">
                        <div class="profile-background" id="profile-background" style="height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); position: relative; background-size: cover; background-position: center;">
                            <div class="position-absolute top-0 end-0 p-3">
                                <button class="btn btn-sm btn-light" onclick="editBackground()" title="Change Background">
                                    <i class="bi bi-camera"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body position-relative" style="margin-top: -60px;">
                            <div class="d-flex align-items-end justify-content-between">
                                <div class="d-flex align-items-end">
                                    <div class="profile-avatar position-relative" style="z-index: 10;">
                                        <div id="profile-avatar" style="width: 120px; height: 120px; border: 4px solid white; border-radius: 50%; background: #ddd; overflow: hidden;">
                                            <!-- Avatar will be inserted here -->
                                        </div>
                                        <button class="btn btn-sm btn-primary position-absolute bottom-0 end-0" onclick="editProfilePicture()" style="border-radius: 50%; width: 32px; height: 32px; padding: 0;">
                                            <i class="bi bi-camera"></i>
                                        </button>
                                    </div>
                                    <div class="ms-3 text-white" style="margin-bottom: 10px;">
                                        <h1 class="mb-0" id="profile-name">Loading...</h1>
                                        <p class="mb-0" id="profile-email">Loading...</p>
                                        <p class="mb-0 opacity-75">Member since <span id="member-since">Loading...</span></p>
                                    </div>
                                </div>
                                <div class="mb-2">
                                    <button class="btn btn-primary" onclick="editProfile()">
                                        <i class="bi bi-pencil me-2"></i>Edit Profile
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-4">
                    <!-- Profile Info Card -->
                    <div class="card border-0 shadow-sm mb-4">
                        <div class="card-body">
                            <h5 class="card-title">About</h5>
                            <div id="profile-introduction">
                                <p class="introduction-text">Welcome to my profile!</p>
                            </div>
                            <div id="profile-bio">
                                <p class="about-text">No bio yet.</p>
                            </div>
                            
                            <!-- Social Links -->
                            <div id="social-links" class="mt-3">
                                <h6>Connect with me</h6>
                                <div class="social-links-container">
                                    <!-- Social links will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Card -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Statistics</h5>
                            <div class="row text-center">
                                <div class="col-6 stat-photos">
                                    <div class="stat-number">0</div>
                                    <div class="stat-label">Photos</div>
                                </div>
                                <div class="col-6 stat-views">
                                    <div class="stat-number">0</div>
                                    <div class="stat-label">Views</div>
                                </div>
                            </div>
                            <div class="row text-center mt-3">
                                <div class="col-6 stat-member">
                                    <div class="stat-number">2024</div>
                                    <div class="stat-label">Member Since</div>
                                </div>
                                <div class="col-6 stat-account">
                                    <div class="stat-number">Free</div>
                                    <div class="stat-label">Account</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <!-- Recent Activity -->
                    <div class="card border-0 shadow-sm">
                        <div class="card-body">
                            <h5 class="card-title">Recent Activity</h5>
                            <div id="recent-activity">
                                <div class="text-center py-4">
                                    <i class="bi bi-clock text-muted" style="font-size: 2rem;"></i>
                                    <p class="text-muted mt-2">No recent activity</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Profile Edit Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-labelledby="editProfileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editProfileModalLabel">Edit Profile</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="profileEditForm">
                        <div class="mb-3">
                            <label for="edit-introduction" class="form-label">Introduction</label>
                            <textarea class="form-control" id="edit-introduction" rows="2" placeholder="A brief introduction about yourself"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-bio" class="form-label">Bio</label>
                            <textarea class="form-control" id="edit-bio" rows="4" placeholder="Tell us more about yourself and your passion for railroads"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="edit-profile-picture" class="form-label">Profile Picture URL</label>
                            <input type="url" class="form-control" id="edit-profile-picture" placeholder="https://example.com/profile-image.jpg">
                            <div class="form-text">Enter a URL to your profile picture</div>
                        </div>
                        <div class="mb-3">
                            <label for="edit-background-image" class="form-label">Background Image URL</label>
                            <input type="url" class="form-control" id="edit-background-image" placeholder="https://example.com/background-image.jpg">
                            <div class="form-text">Enter a URL to your profile background image</div>
                        </div>
                        
                        <h6>Social Links</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="edit-twitter" class="form-label">Twitter</label>
                                <input type="url" class="form-control" id="edit-twitter" placeholder="https://twitter.com/username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-instagram" class="form-label">Instagram</label>
                                <input type="url" class="form-control" id="edit-instagram" placeholder="https://instagram.com/username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-facebook" class="form-label">Facebook</label>
                                <input type="url" class="form-control" id="edit-facebook" placeholder="https://facebook.com/username">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="edit-website" class="form-label">Website</label>
                                <input type="url" class="form-control" id="edit-website" placeholder="https://yourwebsite.com">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveProfileChanges()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="assets/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentProfile = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof initAuthButtons === 'function') {
                initAuthButtons();
            }
            
            // Load user profile data
            loadUserProfile();
        });
        
        async function loadUserProfile() {
            try {
                // Wait for Clerk to load
                if (!window.Clerk) {
                    await new Promise(resolve => {
                        const checkClerk = () => {
                            if (window.Clerk) resolve();
                            else setTimeout(checkClerk, 100);
                        };
                        checkClerk();
                    });
                }
                
                await Clerk.load();
                
                if (!Clerk.user) {
                    // Redirect to sign in if not authenticated
                    window.location.href = 'index.html';
                    return;
                }
                
                // Update header with Clerk data first
                updateProfileHeader();
                
                // Fetch enhanced profile data from API
                const [profile, stats] = await Promise.all([
                    fetchUserProfile(),
                    fetchUserStats()
                ]);
                
                currentProfile = profile;
                updateProfileContent(profile, stats);
                
            } catch (error) {
                console.error('Error loading profile:', error);
                showError('Failed to load profile data. Please try again.');
            }
        }
        
        function updateProfileHeader() {
            const user = Clerk.user;
            const firstName = user.firstName || '';
            const lastName = user.lastName || '';
            const displayName = formatUserName(firstName, lastName);
            const userImageUrl = user.imageUrl;
            const userInitials = (firstName ? firstName[0] : '') + (lastName ? lastName[0] : '');
            
            // Update profile header
            document.getElementById('profile-name').textContent = displayName;
            document.getElementById('profile-email').textContent = user.emailAddresses[0]?.emailAddress || '';
            
            const memberSince = new Date(user.createdAt).getFullYear();
            document.getElementById('member-since').textContent = memberSince;
            
            const avatarContainer = document.getElementById('profile-avatar');
            if (userImageUrl) {
                avatarContainer.innerHTML = `<img src="${userImageUrl}" alt="${displayName}" class="w-100 h-100" style="object-fit: cover;">`;
            } else {
                avatarContainer.innerHTML = `<div class="w-100 h-100 bg-primary text-white d-flex align-items-center justify-content-center" style="font-size: 48px; font-weight: 500;">${userInitials}</div>`;
            }
        }
        
        function updateProfileContent(profile, stats) {
            // Update introduction and bio
            if (profile.introduction && profile.introduction !== 'Welcome to my profile!') {
                document.querySelector('.introduction-text').textContent = profile.introduction;
            }
            
            if (profile.about_me && profile.about_me !== 'No bio yet.') {
                document.querySelector('.about-text').textContent = profile.about_me;
            }
            
            // Update custom profile picture if available
            if (profile.profile_picture_url) {
                const avatarContainer = document.getElementById('profile-avatar');
                avatarContainer.innerHTML = `<img src="${profile.profile_picture_url}" alt="Profile Picture" class="w-100 h-100" style="object-fit: cover;">`;
            }
            
            // Update background image if available
            if (profile.background_image_url) {
                const backgroundContainer = document.getElementById('profile-background');
                backgroundContainer.style.backgroundImage = `url(${profile.background_image_url})`;
            }
            
            // Update social links
            updateSocialLinks(profile.social_links || {});
            
            // Update stats
            document.querySelector('.stat-photos .stat-number').textContent = stats.photos_uploaded || 0;
            document.querySelector('.stat-views .stat-number').textContent = stats.total_views || 0;
            
            // Format member since date
            const memberSince = new Date(stats.member_since);
            document.querySelector('.stat-member .stat-number').textContent = memberSince.getFullYear();
            
            // Update account type based on settings
            const settings = profile.settings || {};
            const accountType = settings.subscription || 'Free';
            document.querySelector('.stat-account .stat-number').textContent = accountType;
        }
        
        function updateSocialLinks(socialLinks) {
            const container = document.querySelector('.social-links-container');
            const socialPlatforms = [
                { key: 'twitter', icon: 'twitter', label: 'Twitter' },
                { key: 'instagram', icon: 'instagram', label: 'Instagram' },
                { key: 'facebook', icon: 'facebook', label: 'Facebook' },
                { key: 'website', icon: 'globe', label: 'Website' }
            ];
            
            let linksHTML = '';
            socialPlatforms.forEach(platform => {
                if (socialLinks[platform.key]) {
                    linksHTML += `
                        <a href="${socialLinks[platform.key]}" target="_blank" class="btn btn-outline-primary btn-sm me-2 mb-2">
                            <i class="bi bi-${platform.icon} me-1"></i>${platform.label}
                        </a>
                    `;
                }
            });
            
            if (linksHTML) {
                container.innerHTML = linksHTML;
            } else {
                container.innerHTML = '<p class="text-muted small">No social links added yet.</p>';
            }
        }
        
        function editProfile() {
            if (!currentProfile) {
                showError('Profile data not loaded yet.');
                return;
            }
            
            // Populate the edit form with current data
            document.getElementById('edit-introduction').value = currentProfile.introduction || '';
            document.getElementById('edit-bio').value = currentProfile.about_me || '';
            document.getElementById('edit-profile-picture').value = currentProfile.profile_picture_url || '';
            document.getElementById('edit-background-image').value = currentProfile.background_image_url || '';
            
            // Populate social links
            const socialLinks = currentProfile.social_links || {};
            document.getElementById('edit-twitter').value = socialLinks.twitter || '';
            document.getElementById('edit-instagram').value = socialLinks.instagram || '';
            document.getElementById('edit-facebook').value = socialLinks.facebook || '';
            document.getElementById('edit-website').value = socialLinks.website || '';
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('editProfileModal'));
            modal.show();
        }
        
        function editProfilePicture() {
            const url = prompt('Enter the URL for your profile picture:');
            if (url) {
                updateProfile({ profile_picture_url: url });
            }
        }
        
        function editBackground() {
            const url = prompt('Enter the URL for your background image:');
            if (url) {
                updateProfile({ background_image_url: url });
            }
        }
        
        async function saveProfileChanges() {
            try {
                const profileData = {
                    introduction: document.getElementById('edit-introduction').value,
                    about_me: document.getElementById('edit-bio').value,
                    profile_picture_url: document.getElementById('edit-profile-picture').value,
                    background_image_url: document.getElementById('edit-background-image').value,
                    social_links: {
                        twitter: document.getElementById('edit-twitter').value,
                        instagram: document.getElementById('edit-instagram').value,
                        facebook: document.getElementById('edit-facebook').value,
                        website: document.getElementById('edit-website').value
                    }
                };
                
                await updateProfile(profileData);
                
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('editProfileModal'));
                modal.hide();
                
                showSuccess('Profile updated successfully!');
                
                // Reload profile data
                setTimeout(() => {
                    location.reload();
                }, 1000);
                
            } catch (error) {
                console.error('Error saving profile:', error);
                showError('Failed to save profile changes. Please try again.');
            }
        }
        
        async function updateProfile(data) {
            const result = await updateUserProfile(data);
            currentProfile = { ...currentProfile, ...data };
            return result;
        }
        
        function showError(message) {
            const container = document.querySelector('.container');
            const errorHTML = `
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', errorHTML);
        }
        
        function showSuccess(message) {
            const container = document.querySelector('.container');
            const successHTML = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            `;
            container.insertAdjacentHTML('afterbegin', successHTML);
            
            // Auto-dismiss after 3 seconds
            setTimeout(() => {
                const alert = document.querySelector('.alert-success');
                if (alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }
            }, 3000);
        }
    </script>
</body>
</html>